<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Деплой Phoenix-приложений через Edeliver. Часть&nbsp;2 |> Сообщество Elixir и Phoenix Framework</title>
    <meta name="description" content="Введение в деплой приложений, написанных на Phoenix. Продолжение.">

    <link rel="alternate" type="application/rss+xml" title="Сообщество Elixir и Phoenix Framework" href="/feed.xml" />
    <link rel="canonical" href="https://wunsh.ru/articles/deploy-phoenix-part-2.html">

    <style type="text/css">@import url("//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&subset=cyrillic");</style>
    <link rel="stylesheet" href="/assets/css/vendors/pure.min.css">
    <link rel="stylesheet" href="/assets/css/vendors/pure-grids-responsive.min.css">
    <link rel="stylesheet" href="/assets/css/style.css?1594516983">

    <link rel="shortcut icon" type="image/png" href="/assets/favicon.png" >
</head>


  <body>
    <div class="wunsh pure-g">
      




<div class="menu pure-u-1 pure-u-md-1-4">
  <div class="header">
    <h2 class="header__title">
      
        <a href="https://wunsh.ru" class="header__title_link" title="На главную">Эликсир и&nbsp;Вунш</a>
      
    </h2>
    <h3 class="header__tagline">Erlang + Ruby = &#10084;</h3>

    <nav class="nav">
      <ul class="nav_list">
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/elixir" class="nav_list__item_link pure-button">О языке</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/install/linux-asdf" class="nav_list__item_link pure-button">Установка</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/docs/" class="nav_list__item_link pure-button">Документация</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/guides" class="nav_list__item_link pure-button">Гайды</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/news" class="nav_list__item_link pure-button">Новости</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/articles" class="nav_list__item_link pure-button">Статьи</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/videos" class="nav_list__item_link pure-button">Видео</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/vacancies" class="nav_list__item_link pure-button">Вакансии</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/faq" class="nav_list__item_link pure-button">FAQ</a>
            </li>
          
        
      </ul>
    </nav>

    <a href="#subscribeModal" class="pure-button header__subscribe_link">Подписаться на рассылку</a>
  </div>
</div>


      <div class="content pure-u-1 pure-u-md-3-4">
        

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post__header">
    
    <h1 class="post__title" itemprop="name headline">Деплой Phoenix-приложений через Edeliver. Часть&nbsp;2</h1>

    <div class="post__meta post_meta">
      <ul class="meta_list">
        <li class="meta_list__item">
          
          <span class="">
            <small class="meta_list__item_name">Дата</small>
            <time class="h-bold" datetime="2017-03-31T00:00:00+00:00" itemprop="datePublished">
              















31 марта 2017

            </time>
          </span>
          

          
        </li>
        
        <li class="meta_list__item">
            <span class="tag_cloud tags_cloud--inline h-no_margin">
              <small class="meta_list__item_name">Теги</small> 


<ul class="tags_cloud__list">
  
    <a href="/tags/#deploy" class="tags_cloud__link tag tag--deploy">deploy</a>
  
    <a href="/tags/#phoenix" class="tags_cloud__link tag tag--phoenix">phoenix</a>
  
</ul>

            </span>
        </li>
        
        <li class="meta_list__item">
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <small class="meta_list__item_name">
              
                Перевод
              
            </small>
            <span itemprop="name" class="h-bold">Надежда Нестерова</span>
          </span>
        </li>

        <li class="meta_list__item">
          
            <div >
              <small>Оригинал</small>
              <strong>
                &laquo;<a href="https://shovik.com/blog/6-deploying-phoenix-apps-for-rails-developers" style="text-transform: none; text-decoration: underline; color: #4b2e39;">Deploying Phoenix Apps for Rails Developers</a>&raquo;
              </strong>
              <small>&copy;</small>
              <strong>Alex Kovshovik</strong>
            </div>
          
        </li>
      </ul>
    </div>
  </header>

  <div class="post__content" itemprop="articleBody">
    <p>В <a href="/articles/deploy-phoenix-part-1.html">предыдущей части</a> мы составили план деплоя приложений, написанных на Elixir с использованием Phoenix. Теперь пришло время подробно раскрыть каждый из шагов и ответить на основные вопросы.</p>

<h2>Шаг 1.&nbsp;Создание нового Phoenix-приложения</h2>
<p>Чтобы создать новое приложение, <a href="http://www.phoenixframework.org/docs/up-and-running">следуйте этой инструкции</a> или просто запустите соответствующую команду в&nbsp;терминале:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">mix</span> <span class="n">phoenix</span><span class="o">.</span><span class="n">new</span> <span class="n">edelivered_app</span></code></pre></figure>
<p>Теперь Phoenix-приложение должно появиться в&nbsp;директории <code>edelivered_app</code>. Следуйте указаниям команды <code>mix phoenix.new</code>, и&nbsp;убедитесь, что приложение запускается на&nbsp;вашей системе.</p>
<p>Укажите реквизиты базы данных в&nbsp;файле <code>config/prod.secret.exs</code>. Можно смело использовать ту&nbsp;же&nbsp;базу данных, что и&nbsp;для dev-окружения, т.к. этот файл не&nbsp;добавляется в&nbsp;систему контроля версий, и на сервере будет его другая копия. Чтобы можно было создать релиз для продакшна, локальное приложение должно корректно работать в&nbsp;режиме &laquo;prod&raquo;.</p>
<p>Убедитесь, что команды корректно выполняются:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="no">MIX_ENV</span><span class="o">=</span><span class="n">prod</span> <span class="n">mix</span> <span class="n">ecto</span><span class="o">.</span><span class="n">create</span>    <span class="c1"># create prod database if not the same as dev database.</span>
<span class="no">MIX_ENV</span><span class="o">=</span><span class="n">prod</span> <span class="n">mix</span> <span class="n">phoenix</span><span class="o">.</span><span class="n">server</span> <span class="c1"># run phoenix server in prod mode.</span></code></pre></figure>
<p>Инициализируйте пустой Git-репозиторий и&nbsp;сделайте начальный коммит.</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">git</span> <span class="n">init</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">am</span> <span class="sd">"</span><span class="s2">Initial commit. First!"</span></code></pre></figure>
<h2>Шаг&nbsp;2.&nbsp;Настройка distillery для создания релизов</h2>
<p>Как гласит <a href="https://hexdocs.pm/distillery/terminology.html#content">документация distillery</a>:</p>
<blockquote><em>Релиз&nbsp;&mdash; это пакет, состоящий из&nbsp;файлов с&nbsp;расширением .beam, включающих зависимости приложения, sys.config, vm.args, сценарий загрузки, а&nbsp;также различные утилиты и&nbsp;файлы метаданных, предназначенные для управления релизом после его установки. Кроме этого, релиз может также включать копию ERTS.</em></blockquote>
<p>Фактически релиз представляет собой архив (<code>*.tar.gz</code>) со&nbsp;скомпилированным приложением и&nbsp;всеми его зависимостями, включая саму среду выполнения.</p>
<p>Созданный релиз помещается на&nbsp;сервер, и&nbsp;затем происходит его развёртывание с&nbsp;помощью Edeliver (подробнее <a href="https://shovik.com/blog/6-deploying-phoenix-apps-for-rails-developers#distillery">здесь</a>).</p>
<p>Добавьте в&nbsp;<code>mix.exs</code> следующий код:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="c1">#...,</span>
    <span class="p">{</span><span class="ss">:distillery</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}</span>
  <span class="p">]</span>
<span class="k">end</span></code></pre></figure>
<p>и&nbsp;запустите</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">mix</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span></code></pre></figure>
<p>Создайте файл конфигурации релиза:</p>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">mix release.init</code></pre></figure>
<p>Откройте созданный файл <code>rel/config.exs</code>. По&nbsp;умолчанию релиз будет сконфигурирован для двух окружений: <code>dev</code> и&nbsp;<code>prod</code>. В&nbsp;конфигурацию можно добавлять и&nbsp;другие релизы и&nbsp;окружения, однако пока остановимся на&nbsp;конфигурации по&nbsp;умолчанию, но&nbsp;с&nbsp;одной оговоркой.</p>
<p>Создавать и&nbsp;запускать distillery-релиз в&nbsp;режиме dev&nbsp;&mdash; бессмысленно, так как это всё равно не&nbsp;сработает (<a href="https://github.com/bitwalker/distillery/issues/25">https://github.com/bitwalker/distillery/issues/25</a>).</p>
<p>Поэтому нужно поставить окружение <code>prod</code> в&nbsp;настройках по&nbsp;умолчанию. Замените <code>default_environment</code> в&nbsp;<code>rel/config.exs</code> на&nbsp;&laquo;prod&raquo;.</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir">  <span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Releases</span><span class="o">.</span><span class="no">Config</span><span class="p">,</span>
  <span class="c1"># This sets the default release built by `mix release`</span>
  <span class="ss">default_release:</span> <span class="ss">:default</span><span class="p">,</span>
  <span class="c1"># This sets the default environment used by `mix release`</span>
  <span class="ss">default_environment:</span> <span class="ss">:prod</span> <span class="c1"># &lt;------ SET THIS TO :prod</span></code></pre></figure>
<p>Обязательно загляните на&nbsp;страницу <a href="https://hexdocs.pm/distillery/terminology.html#content">терминологии distillery</a>. Это поможет избежать суеты при возникновении ошибок и&nbsp;поиска в&nbsp;интернете решений по&nbsp;их&nbsp;исправлению.</p>
<p>Измените точку входа Endpoint в&nbsp;файле <code>config/prod.exs</code> на&nbsp;следующую:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir">  <span class="n">config</span> <span class="ss">:edelivered_app</span><span class="p">,</span> <span class="no">EdeliveredApp</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span>
  <span class="ss">http:</span> <span class="p">[</span><span class="ss">port:</span> <span class="p">{</span><span class="ss">:system</span><span class="p">,</span> <span class="sd">"</span><span class="s2">PORT"</span><span class="p">}],</span>
  <span class="ss">url:</span> <span class="p">[</span><span class="ss">host:</span> <span class="sd">"</span><span class="s2">localhost"</span><span class="p">,</span> <span class="ss">port:</span> <span class="p">{</span><span class="ss">:system</span><span class="p">,</span> <span class="sd">"</span><span class="s2">PORT"</span><span class="p">}],</span>
  <span class="ss">cache_static_manifest:</span> <span class="sd">"</span><span class="s2">priv/static/manifest.json"</span><span class="p">,</span>
  <span class="ss">server:</span> <span class="no">true</span><span class="p">,</span>
  <span class="ss">root:</span> <span class="sd">"</span><span class="s2">."</span><span class="p">,</span>
  <span class="ss">version:</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Project</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="ss">:version</span><span class="p">]</span></code></pre></figure>
<p>Важно, чтобы порты, указанные в&nbsp;опциях <code>http</code> и&nbsp;<code>url</code>, совпадали. Подробнее об&nbsp;этих опциях читайте <a href="https://hexdocs.pm/distillery/use-with-phoenix.html#configuring-your-release">здесь</a>.</p>
<p>Теперь всё готово для создания первого релиза.</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="no">MIX_ENV</span><span class="o">=</span><span class="n">prod</span> <span class="n">mix</span> <span class="n">release</span></code></pre></figure>
<p>Даже если установить prod-окружение по&nbsp;умолчанию, distillery всё равно будет работать в&nbsp;dev-окружении Mix. Поэтому измените <code>MIX_ENV</code> на&nbsp;&laquo;prod&raquo; и&nbsp;только после этого выполните команду <code>mix release</code>.</p>
<p>Вот вы&nbsp;и&nbsp;создали свой релиз для продакшна!</p>
<h2>Шаг&nbsp;3.&nbsp;Локальное тестирование релиза distillery</h2>
<p>По&nbsp;умолчанию релизы располагаются в&nbsp;директории <code>_build/&lt;env&gt;/rel/&lt;app-name&gt;</code>, и&nbsp;можно запускать релиз прямо оттуда. Однако, для демонстрации переносимости релизов на&nbsp;Elixir, извлечём архив с&nbsp;релизом в&nbsp;отдельную папку и&nbsp;проведём запуск из&nbsp;неё.</p>
<ol>
  <li>Создайте директорию для своего приложения: <code>mkdir ~/Downloads/edelivered_app</code></li>
  <li>Поместите копию релиза в&nbsp;эту директорию: <code>cp _build/prod/rel/edelivered_app/releases/0.0.1/edelivered_app.tar.gz ~/Downloads/edelivered_app/</code></li>
  <li>Откройте директорию назначения: <code>cd ~/Downloads/edelivered_app/</code></li>
  <li>Извлеките файлы из&nbsp;архива <code>tar -zxvf edelivered_app.tar.gz</code> Никогда не&nbsp;мог запомнить эти переключатели <code>tar</code>, так как не&nbsp;особо часто извлекаю файлы типа <code>*.tar.gz</code>. Специально для этого я&nbsp;создал документ в&nbsp;Evernote. <stromg>Подсказка:</stromg> создайте простенький сценарий и&nbsp;назовите его <code>untar</code>.</li>
  <li>Запустите приложение: <code>PORT=8080&nbsp;bin/edelivered_app foreground</code>. Убедитесь, что <strong>обязательная</strong> переменная среды PORT соответствует необходимому порту.</li>
</ol>
<p>Воспользуемся командой &laquo;foreground&raquo;, чтобы для начала запустить приложение в&nbsp;обычном режиме и&nbsp;выявить существующие на&nbsp;данном этапе ошибки.</p>
<p>Если всё прошло нормально, то&nbsp;можно запустить приложение в&nbsp;фоновом режиме (в&nbsp;качестве демона):</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="no">PORT</span><span class="o">=</span><span class="m">8080</span> <span class="n">bin</span><span class="o">/</span><span class="n">edelivered_app</span> <span class="n">start</span></code></pre></figure>
<p>Используйте этот&nbsp;же скрипт для остановки и&nbsp;перезапуска приложения, а&nbsp;также для подключения к нему. Наиболее полезные команды:</p>
<ul>
  <li><code>bin/edelivered_app</code> выводит список доступных команд.</li>
  <li><code>bin/edelivered_app stop</code> останавливает приложение.</li>
  <li><code>bin/edelivered_app ping</code> дает обратную связь &laquo;pong&raquo;, если в&nbsp;приложении нет ошибок.</li>
  <li><code>bin/edelivered_app remote_console</code> подключается к&nbsp;запущенному релизу через консоль IEx. В&nbsp;отличие от&nbsp;&laquo;console&raquo; и&nbsp;&laquo;attach&raquo;, &laquo;remote_console&raquo; не&nbsp;завершает запущенный релиз при выходе из&nbsp;консоли.</li>
</ul>
<p>После развёртывания можно использовать те&nbsp;же команды на&nbsp;продакшн сервере/серверах.</p>
<p>Сделайте коммит внесённых изменений: <code>git commit -am "Add distillery dependency"</code></p>
<p>Более подробную информацию о&nbsp;создании релизов можно найти в&nbsp;инструкции по&nbsp;установке на&nbsp;<a href="https://github.com/bitwalker/distillery">странице distillery в&nbsp;GitHub</a> или вот в&nbsp;этом <a href="https://hexdocs.pm/distillery/use-with-phoenix.html">чудесном гайде</a>. Очень рекомендуется изучить документацию distillery полностью, так как в&nbsp;ней содержится достаточно много информации о&nbsp;релизах, а&nbsp;также рассказывается о&nbsp;способах устранения ошибок, к&nbsp;коим мы&nbsp;ещё вернёмся в&nbsp;конце данной статьи.</p>
<h2>Шаг&nbsp;4.&nbsp;Подготовка сервера в&nbsp;облаке</h2>
<p>Нам понадобится сервер Ubuntu&nbsp;16.04&nbsp;с открытым 22&nbsp;SSH-портом, IP&nbsp;адресом и&nbsp;root-доступом.</p>
<p>Для создания сервера можно пользоваться абсолютно любым провайдером облачных вычислений. Из российских хостингов отлично себя зарекомендовал <a href="https://vscale.io/?refcode=pca5dot4jy">Vscale</a>. Ценовая политика у&nbsp;него вполне приемлема. Всё, что нам потребуется,&nbsp;&mdash; это минимум 1&nbsp;Гб оперативной памяти. Можно, конечно, сэкономить и&nbsp;рассмотреть вариант с&nbsp;512&nbsp;Мб, но&nbsp;тогда придётся увеличить область подкачки, чтобы на&nbsp;таком сервере можно было создавать релизы, что, к&nbsp;слову сказать, будет происходить крайне медленно. Посмотреть на&nbsp;примере, как увеличить область подкачки, можно <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-16-04">здесь</a>. Надеюсь, выделенное красным предупреждение в&nbsp;самом начале поста сможет посеять в&nbsp;ваши мысли зерно сомнения.</p>
<p>Ещё один вариант&nbsp;&mdash; установить Ubuntu&nbsp;16.04&nbsp;LTS на&nbsp;виртуальную машину. <a href="https://www.virtualbox.org/">VirtualBox</a> вполне подойдёт. Настройте сеть виртуальной машины: выберите NAT (Network Address Translation), чтобы стало возможным подключение к&nbsp;ней по&nbsp;SSH и&nbsp;HTTP/HTTPS.</p>
<p>Дабы упростить себе жизнь, забудем про Chef, Ansible и&nbsp;другие DevOps инструменты.</p>
<p>Выполните следующее:</p>
<ol>
  <li>Создайте нового пользователя &laquo;app&raquo; в&nbsp;домашней директории: <code>adduser app</code>.</li>
  <li>Поместите свой публичный RSA-ключ в&nbsp;<code>/home/app/.ssh/authorized_keys</code> для подключения к&nbsp;серверу по&nbsp;SSH без необходимости ввода пароля. Создайте директорию <code>.ssh</code>, если её&nbsp;не&nbsp;существует.</li>
  <li>Установите следующие права доступа:</p>
    <ul>
      <li><code>chmod 700 /home/app/.ssh</code></li>
      <li><code>chmod 644 /home/app/.ssh/authorized_keys</code></li>
      <li><code>chown -R app:app /home/app/.ssh</code></li>
    </ul>
  </li>
  <li>Для удобства добавьте пользователя &laquo;app&raquo; в&nbsp;группу <code>sudo</code>: внесите правки в&nbsp;файл <code>/etc/group</code> и&nbsp;поместите app в&nbsp;конец строки &laquo;sudo&raquo;.</li>
  <li>Подключитесь к&nbsp;серверу по&nbsp;SSH в&nbsp;качестве пользователя <code>app</code>; пароль запрашиваться не&nbsp;должен.</li>
  <li>Следуйте <a href="http://elixir-lang.org/install.html#unix-and-unix-like">инструкции по&nbsp;установке Ubuntu для Elixir</a>. Установите Erlang и&nbsp;Elixir.</li>
  <li>Следуйте <a href="http://tecadmin.net/install-latest-nodejs-npm-on-ubuntu/">указаниям по&nbsp;установке NodeJs и&nbsp;NPM в&nbsp;Ubuntu</a>.</li>
  <li>Установите git: <code>sudo apt-get install git</code></li>
  <li>Установите сервер базы данных Postgres: <code>sudo apt-get install postgresql postgresql-contrib</code>. </li>
  <li>Настройте роль Postgres для данного пользователя:</p>
    <ul>
      <li>Переключитесь на&nbsp;linux-пользователя &laquo;postgres&raquo;: <code>sudo su - postgres</code></li>
      <li>Запустите консольный клиент Postgres: <code>psql</code>
        <ul>
          <li><code>CREATE ROLE app WITH superuser;</code></li>
          <li><code>ALTER ROLE app WITH login;</code></li>
          <li><code>ALTER ROLE app WITH createdb;</code></li>
          <li><code>ALTER USER app WITH PASSWORD 'coolpass';</code> Надеюсь, вы&nbsp;не&nbsp;будете использовать этот пароль для своих реальных серверов :)</li>
        </ul>
      </li>

      <li>Закройте консольный клиент Postres: Ctrd+D.</li>
      <li>Выполните выход пользователя postgres: exit или Ctrl+D.</li>
    </ul>
  </li>
  <li>Создайте базу данных Postgres для своего приложения: <code>createdb edelivered_app_prod</code></li>
  <li>Создайте директорию приложения и&nbsp;настроек: <code>mkdir /home/app/mysite.com</code></li>
  <li>Создайте директорию хранения релизов: <code>mkdir /home/app/mysite.com/edeliver_release_store</code></li>
  <li>Добавьте глобальную переменную окружения PORT: <code>echo "PORT=8080" | sudo tee -a /etc/environment</code></li>
  <li>Добавьте ещё одну глобальную переменную окружения MIX_ENV: <code>echo "MIX_ENV=prod" | sudo tee -a /etc/environment</code></li>
</ol>
<h2>Шаг&nbsp;5.&nbsp;Развёртывание distillery-релиза в&nbsp;продакшн с&nbsp;помощью Edeliver</h2>
<p>Edeliver&nbsp;&mdash; это набор полезных сценариев для создания релиза при помощи <code>distillery</code> и&nbsp;его развёртывания на&nbsp;некоторое количество серверов. В&nbsp;отличие от&nbsp;Rails и&nbsp;Capistrano, Edeliver подгружает код (используя Git) только на&nbsp;ОДИН сервер (билд-сервер), там&nbsp;же компилирует его, собирает ассеты, а&nbsp;затем производит развёртывание готового пакета на&nbsp;все серверы. Capistrano по&nbsp;умолчанию производит развёртывание кода и&nbsp;компиляцию ассетов на&nbsp;ВСЕХ серверах.</p>
<p>Добавьте <code>edeliver</code> в&nbsp;список зависимостей проекта и&nbsp;в&nbsp;список приложений:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">def</span> <span class="n">application</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="p">[</span>
  <span class="ss">applications:</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="c1"># Add edeliver to the END of the list</span>
    <span class="ss">:edeliver</span>
  <span class="p">]</span>
<span class="p">]</span>

<span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="o">...</span>
    <span class="p">{</span><span class="ss">:edeliver</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.4.0"</span><span class="p">}</span>
  <span class="p">]</span>
<span class="k">end</span></code></pre></figure>
<p>и&nbsp;запустите</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">mix</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span></code></pre></figure>
<p>В&nbsp;директории проекта создайте файл <code>.deliver/config</code>:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="c1">#!/usr/bin/env bash</span>
<span class="no">APP</span><span class="o">=</span><span class="sd">"</span><span class="s2">edelivered_app"</span> <span class="c1"># &lt;--- THIS MUST MATCH THE NAME OF THE RELEASE IN rel/config.exs</span>
                     <span class="c1">#      AND THE NAME OF THE APP IN config/mix.exs!!!!!!!!!!</span>

<span class="c1"># Configuration of where the releases would be built.</span>
<span class="no">BUILD_HOST</span><span class="o">=</span><span class="sd">"</span><span class="s2">138.197.37.15"</span> <span class="c1"># change to your server's IP address</span>
<span class="no">BUILD_USER</span><span class="o">=</span><span class="sd">"</span><span class="s2">app"</span>
<span class="no">BUILD_AT</span><span class="o">=</span><span class="sd">"</span><span class="s2">/home/app/mysite.com/edeliver_builds"</span>

<span class="c1"># The location where built releases are going to be stored.</span>
<span class="no">RELEASE_STORE</span><span class="o">=</span><span class="n">app</span><span class="err">@</span><span class="m">138.197</span><span class="o">.</span><span class="m">37.15</span><span class="ss">:/</span><span class="n">home</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mysite</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">edeliver_release_store</span><span class="o">/</span>

<span class="c1"># Host and use of where the app would run.</span>
<span class="no">PRODUCTION_HOSTS</span><span class="o">=</span><span class="sd">"</span><span class="s2">138.197.37.15"</span> <span class="c1"># same host in our case.</span>
<span class="no">PRODUCTION_USER</span><span class="o">=</span><span class="sd">"</span><span class="s2">app"</span>

<span class="no">DELIVER_TO</span><span class="o">=</span><span class="sd">"</span><span class="s2">/home/app/mysite.com"</span>

<span class="n">pre_erlang_get_and_update_deps</span><span class="p">()</span> <span class="p">{</span>
 <span class="c1"># copy it on the build host to the build directory when building</span>
 <span class="n">local</span> <span class="n">_secret_config_file_on_build_host</span><span class="o">=</span><span class="sd">"</span><span class="s2">/home/app/mysite.com/prod.secret.exs"</span>

 <span class="n">status</span> <span class="sd">"</span><span class="s2">Linking '$_secret_config_file_on_build_host' to build config dir"</span>
 <span class="n">__sync_remote</span> <span class="sd">"</span><span class="s2">
   ln -sfn '$_secret_config_file_on_build_host' '$BUILD_AT/config/prod.secret.exs'
 "</span>
<span class="p">}</span>

<span class="n">pre_erlang_clean_compile</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">status</span> <span class="sd">"</span><span class="s2">Installing nodejs dependencies"</span>
 <span class="n">__sync_remote</span> <span class="sd">"</span><span class="s2">
   [ -f ~/.profile ] &amp;&amp; source ~/.profile
   set -e
   cd '$BUILD_AT'

   APP='$APP' MIX_ENV='$TARGET_MIX_ENV' npm install
 "</span>

 <span class="n">status</span> <span class="sd">"</span><span class="s2">Building brunch assets"</span>
 <span class="n">__sync_remote</span> <span class="sd">"</span><span class="s2">
   [ -f ~/.profile ] &amp;&amp; source ~/.profile
   set -e
   cd '$BUILD_AT'

   mkdir -p priv/static
   APP='$APP' MIX_ENV='$TARGET_MIX_ENV' npm run deploy
 "</span>

 <span class="n">status</span> <span class="sd">"</span><span class="s2">Compiling code"</span>
 <span class="n">__sync_remote</span> <span class="sd">"</span><span class="s2">
   [ -f ~/.profile ] &amp;&amp; source ~/.profile
   set -e </span><span class="err">#</span><span class="s2">
   cd '$BUILD_AT'

   APP='$APP' MIX_ENV='$TARGET_MIX_ENV' $MIX_CMD do deps.get, compile
 "</span>

 <span class="n">status</span> <span class="sd">"</span><span class="s2">Running phoenix.digest"</span>
 <span class="n">__sync_remote</span> <span class="sd">"</span><span class="s2">
   [ -f ~/.profile ] &amp;&amp; source ~/.profile
   set -e </span><span class="err">#</span><span class="s2">
   cd '$BUILD_AT'

   APP='$APP' MIX_ENV='$TARGET_MIX_ENV' $MIX_CMD phoenix.digest $SILENCE
 "</span>
<span class="p">}</span></code></pre></figure>
<p>Вышеуказанная конфигурация сгенерирует на&nbsp;сервере следующее дерево каталогов:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/home/app/mysite.com        <span class="c"># Your entire app is in one place: configuration, builds and releases.</span>
├── edeliver_builds         <span class="c"># This is where edeliver builds all releases: your local repo is pushed here.</span>
│   ├── brunch-config.js
│   ├── _build
│   ├── config
│   ├── deps
│   ├── lib
│   ├── mix.exs
│   ├── mix.lock
│   ├── node_modules
│   ├── package.json
│   ├── priv
│   ├── README.md
│   ├── rel
│   ├── <span class="nb">test</span>
│   └── web
├── edelivered_app          <span class="c"># Your app is deployed here: this is where it runs, from "bin" directory.</span>
│   ├── bin
│   ├── erl_crash.dump
│   ├── erts-8.2
│   ├── lib
│   ├── releases
│   └── var
├── edeliver_release_store <span class="c"># Edeliver stores all built releases here to then distribute them to servers.</span>
│   └── edelivered_app_0.0.1.release.tar.gz
└── prod.secret.exs        <span class="c"># Your app's secrets: production database connection parameters.</span></code></pre></figure>
<p>Подтвердите изменения и&nbsp;пометьте коммит &laquo;0.0.1&raquo;&nbsp;&mdash; версией, совпадающей с&nbsp;версией вашего проекта в&nbsp;<code>mix.exs</code>.</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">am</span> <span class="sd">"</span><span class="s2">Add edeliver configuration"</span>
<span class="n">git</span> <span class="n">tag</span> <span class="m">0.0</span><span class="o">.</span><span class="m">1</span></code></pre></figure>
<p>Теги впоследствии понадобятся для обновления релизов в&nbsp;edeliver.</p>
<p>Подключитесь к&nbsp;серверу по&nbsp;SSH и&nbsp;создайте файл <code>/home/app/mysite.com/prod.secret.exs</code> со&nbsp;следующим содержимым:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Config</span>

<span class="n">config</span> <span class="ss">:edelivered_app</span><span class="p">,</span> <span class="no">EdeliveredApp</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span>
  <span class="ss">secret_key_base:</span> <span class="sd">"</span><span class="s2">Xt317VM159wCrVgKhatAAbJcz3/yYewpbuXEpBeUpiIEOBVrTWEW878d6vADJU2u"</span>

<span class="n">config</span> <span class="ss">:edelivered_app</span><span class="p">,</span> <span class="no">EdeliveredApp</span><span class="o">.</span><span class="no">Repo</span><span class="p">,</span>
  <span class="ss">adapter:</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Postgres</span><span class="p">,</span>
  <span class="ss">username:</span> <span class="sd">"</span><span class="s2">app"</span><span class="p">,</span>
  <span class="ss">password:</span> <span class="sd">"</span><span class="s2">coolpass"</span><span class="p">,</span>
  <span class="ss">database:</span> <span class="sd">"</span><span class="s2">edelivered_app_prod"</span><span class="p">,</span>
  <span class="ss">pool_size:</span> <span class="m">20</span></code></pre></figure>
<p>Создайте релиз, произведите развёртывание и&nbsp;запустите его:</p>
<ol>
  <li><code>env MIX_ENV=prod mix edeliver build release</code>&nbsp;&mdash; создаёт релиз и&nbsp;помещает его в&nbsp;директорию релизов на&nbsp;сервере.</li>
  <li><code>mix edeliver deploy release to production --version=0.0.1</code> производит развёртывание релиза на&nbsp;все серверы, но&nbsp;не&nbsp;запускает его!</li>
  <li>Попробуйте на&nbsp;всякий случай после первого развёртывания запустить релиз в&nbsp;обычном режиме:

<ul>
  <li>Подключитесь к&nbsp;серверу по&nbsp;SSH в&nbsp;качестве пользователя <code>app</code>.</li>
  <li><code>cd ~/mysite.com/edelivered_app</code></li>
  <li><code>bin/edelivered_app foreground</code></li>
  <li>Убедитесь, что сервер работает и&nbsp;откройте его в&nbsp;браузере: [<a href="http://138.197.37.15:8080">http://138.197.37.15:8080</a>][<a href="http://138.197.37.15:8080">http://138.197.37.15:8080</a>] (ваш IP-адрес, естественно, будет другим)</li>
  <li>Выполните выход: Ctrl+C</li>
</ul>
  </li>
  <li><code>mix edeliver start production</code> запускает приложение на&nbsp;сервере в&nbsp;виде демона!</li>
</ol>
<p>Иногда команда для запуска релиза по&nbsp;какой-то неведомой мне причине не&nbsp;справляется со&nbsp;своими обязанностями. Если после выполнения <code>mix edeliver start production</code> сайт недоступен, подключитесь к&nbsp;серверу по&nbsp;SSH и&nbsp;проверьте, запустился&nbsp;ли процесс Erlang: <code>ps -ef&nbsp;| grep erl</code>. Если нет, то&nbsp;ищите решение в&nbsp;следующем пункте.</p>
<h2>Шаг&nbsp;6.&nbsp;Устранение ошибок</h2>
<p>Последняя версия образца Phoenix-приложения с&nbsp;настроенными distillery и&nbsp;edeliver доступна по&nbsp;ссылке: <a href="https://github.com/alex-kovshovik/edelivered_app">https://github.com/alex-kovshovik/edelivered_app</a>.</p>
<ul>
  <li>Не&nbsp;забывайте прописывать <code>MIX_ENV=prod</code> во&nbsp;всех командах развёртывания.</li>
  <li>Если что-то пошло не&nbsp;так, удалите директорию <code>_build</code> и&nbsp;попробуйте снова.</li>
  <li>Не&nbsp;используйте автоматическую версию AUTO_VERSION с&nbsp;самого начала, попробуйте сперва настроить всё вручную. Мне пришлось пройти через многое в&nbsp;попытках сделать этот способ развёртывания таким&nbsp;же простым, как у&nbsp;Capistrano. Не&nbsp;забывайте увеличивать номер версии своего приложения и&nbsp;создавать тег с&nbsp;таким&nbsp;же именем.</li>
  <li>Значение переменной APP должно совпадать с&nbsp;названием релиза в&nbsp;<code>rel/config.exs</code>. В&nbsp;противном случае получим ошибку: &laquo;Failed to&nbsp;build release: :no_release&raquo;.</li>
  <li>Значение переменной APP должно совпадать с&nbsp;именем приложения, иначе оно не&nbsp;запустится! Я&nbsp;пытался изменить его на&nbsp;&laquo;current_release&raquo;, чтобы оптимизировать дерево каталогов сервера, в&nbsp;результате чего столкнулся с&nbsp;непредвиденными ошибками.</li>
  <li>Полезные переключатели mix edeliver:</p>
    <ul>
      <li><code>--verbose</code>&nbsp;&mdash; отображает результаты работы команд;</li>
      <li><code>--debug</code>&nbsp;&mdash; показывает все команды и&nbsp;их&nbsp;вывод.</li>
    </ul>
  </li>
  <li>Внесите поправку в&nbsp;файл <code>rel/config.exs</code>, как указано в&nbsp;первом комментарии здесь <a href="https://github.com/boldpoker/edeliver/issues/182">distillery support broke with changed output_dir in&nbsp;distillery 1.0.0&nbsp;&mdash; Issue #182</a>.</li>
</ul>
<h2>Шаг&nbsp;7.&nbsp;Что теперь?</h2>
<p>В&nbsp;следующих статьях будет рассмотрено:</p>
<ol>
  <li>Настройка <a href="https://nginx.org/en/">nginx</a> в&nbsp;качестве обратного прокси-сервера для виртуальной машины Erlang.</li>
  <li>Создание и&nbsp;настройка SSL-сертификата с&nbsp;помощью <a href="https://letsencrypt.org/">letsencrypt</a>.</li>
  <li>Создание и&nbsp;развёртывание обновлённых релизов.</li>
  <li>Быстрое создание релизов в&nbsp;docker-контейнерах или на&nbsp;локальной виртуальной машине.</li>
  <li>Создание релизов на&nbsp;CI-сервере.</li>
</ol>
<p> </p>

  </div>

  <!-- uSocial -->
  <div class="post__share_block share_block">
    <script async src="https://usocial.pro/usocial/usocial.js?v=6.1.4" data-script="usocial" charset="utf-8"></script>
    <div class="uSocial-Share" data-pid="2fd19544e551bce292425ee8adaa31be" data-type="share" data-options="round,style2,default,absolute,horizontal,size32,counter1,counter-before,upArrow-right,nomobile" data-social="telegram,fb,vk,gPlus,twi,bookmarks"></div>
  </div>
  <!-- /uSocial -->
</article>


        <footer class="footer">
    &copy; 2020
    / Россия

    <span class="pull-right">Любые мысли и вопросы пишите на <a href="mailto:elixir@wunsh.ru">elixir@wunsh.ru</a>.</span>
</footer>

        <div id="subscribeModal" class="modal">
    <div class="modal__content">
        <a href="#close" title="Close" class="modal__close">x</a>

        <h2 class="modal__title">Ламповая рассылка про&nbsp;Эликсир</h2>

        <p>Один-два раза в&nbsp;неделю присылаем тёплые письма об&nbsp;Эликсире: переводы самых интересных статей до&nbsp;их&nbsp;появления в&nbsp;открытом доступе, анонсы событий и&nbsp;вкусные бонусы.</p>

        <form action="//wunsh.us14.list-manage.com/subscribe/post?u=c81ca3d4693f62db7f7f67c71&amp;id=a192e2dfef" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="pure-form h-tc validate" target="_blank" novalidate>
            <input type="email" value="" name="EMAIL" class="modal__input pure-input-rounded large" id="mce-EMAIL" placeholder="Твоя почта" required>
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_c81ca3d4693f62db7f7f67c71_a192e2dfef" tabindex="-1" value=""></div>

            <input type="submit" value="Присоединиться" name="subscribe" onClick="yaCounter39773490.reachGoal('SUBSCRIBED'); return true" id="mc-embedded-subscribe" class="pure-button button-success large">
        </form>

        <p>Обязательно подтверди почту, перейдя по&nbsp;ссылке в&nbsp;письме, иначе мы&nbsp;не&nbsp;сможем делиться с&nbsp;тобой полезностями.</p>

        <p>Надоедать точно не&nbsp;будем :)</p>
    </div>
</div>

        <script src="/assets/js/vendors/zepto.min.js"></script>

<script>
    if ($(".post--docs").length) {
        $(".footer").addClass("footer--docs")
    }

    $(".modal--close_backdrop").click(function(){
        window.location.hash = "";
    });
</script>

        <!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter39773490 = new Ya.Metrika({
                    id:39773490,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true,
                    ut:"noindex"
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/39773490?ut=noindex" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

      </div>
    </div>
  </body>
</html>
