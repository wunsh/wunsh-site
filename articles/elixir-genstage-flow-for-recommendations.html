<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Использование GenStage и Flow для создания системы рекомендаций товаров |> Сообщество Elixir и Phoenix Framework</title>
    <meta name="description" content="Рассказываем об использовании GenStage и Flow для создания системы рекомендации на языке Elixir.">

    <link rel="alternate" type="application/rss+xml" title="Сообщество Elixir и Phoenix Framework" href="/feed.xml" />
    <link rel="canonical" href="https://wunsh.ru/articles/elixir-genstage-flow-for-recommendations.html">

    <style type="text/css">@import url("//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&subset=cyrillic");</style>
    <link rel="stylesheet" href="/assets/css/vendors/pure.min.css">
    <link rel="stylesheet" href="/assets/css/vendors/pure-grids-responsive.min.css">
    <link rel="stylesheet" href="/assets/css/style.css?1594516983">

    <link rel="shortcut icon" type="image/png" href="/assets/favicon.png" >
</head>


  <body>
    <div class="wunsh pure-g">
      




<div class="menu pure-u-1 pure-u-md-1-4">
  <div class="header">
    <h2 class="header__title">
      
        <a href="https://wunsh.ru" class="header__title_link" title="На главную">Эликсир и&nbsp;Вунш</a>
      
    </h2>
    <h3 class="header__tagline">Erlang + Ruby = &#10084;</h3>

    <nav class="nav">
      <ul class="nav_list">
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/elixir" class="nav_list__item_link pure-button">О языке</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/install/linux-asdf" class="nav_list__item_link pure-button">Установка</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/docs/" class="nav_list__item_link pure-button">Документация</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/guides" class="nav_list__item_link pure-button">Гайды</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/news" class="nav_list__item_link pure-button">Новости</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/articles" class="nav_list__item_link pure-button">Статьи</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/videos" class="nav_list__item_link pure-button">Видео</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/vacancies" class="nav_list__item_link pure-button">Вакансии</a>
            </li>
          
        
          

          
            <li class="nav_list__item ">
              <a href="https://wunsh.ru/faq" class="nav_list__item_link pure-button">FAQ</a>
            </li>
          
        
      </ul>
    </nav>

    <a href="#subscribeModal" class="pure-button header__subscribe_link">Подписаться на рассылку</a>
  </div>
</div>


      <div class="content pure-u-1 pure-u-md-3-4">
        

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post__header">
    
    <h1 class="post__title" itemprop="name headline">Использование GenStage и Flow для создания системы рекомендаций товаров</h1>

    <div class="post__meta post_meta">
      <ul class="meta_list">
        <li class="meta_list__item">
          
          <span class="">
            <small class="meta_list__item_name">Дата</small>
            <time class="h-bold" datetime="2017-03-10T00:00:00+00:00" itemprop="datePublished">
              















10 марта 2017

            </time>
          </span>
          

          
        </li>
        
        <li class="meta_list__item">
            <span class="tag_cloud tags_cloud--inline h-no_margin">
              <small class="meta_list__item_name">Теги</small> 


<ul class="tags_cloud__list">
  
    <a href="/tags/#genstage" class="tags_cloud__link tag tag--genstage">genstage</a>
  
</ul>

            </span>
        </li>
        
        <li class="meta_list__item">
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <small class="meta_list__item_name">
              
                Перевод
              
            </small>
            <span itemprop="name" class="h-bold">Надежда Нестерова</span>
          </span>
        </li>

        <li class="meta_list__item">
          
            <div >
              <small>Оригинал</small>
              <strong>
                &laquo;<a href="https://10consulting.com/2017/01/20/building-product-recommendations-using-elixir-gen-stage-flow" style="text-transform: none; text-decoration: underline; color: #4b2e39;">Using Elixir's GenStage and Flow to Build Product Recommendations</a>&raquo;
              </strong>
              <small>&copy;</small>
              <strong>Ben Smith</strong>
            </div>
          
        </li>
      </ul>
    </div>
  </header>

  <div class="post__content" itemprop="articleBody">
    <h2>Введение</h2>
<blockquote>Flow, подобно модулям Enum и Stream, позволяет разработчикам производить вычисления в коллекциях, однако с его помощью и с помощью GenStage вычисления могут выполняться параллельно.</blockquote>
<p>Канонический пример, размещённый в сервисе <a href="https://github.com/elixir-lang/flow">GitHub</a>, показывает, как с помощью Flow можно параллельно осуществить подсчёт количества слов в документе:</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="no">File</span><span class="o">.</span><span class="n">stream!</span><span class="p">(</span><span class="sd">"</span><span class="s2">path/to/some/file"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">from_enumerable</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="sd">"</span><span class="s2"> "</span><span class="p">))</span>
<span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="p">%{}</span> <span class="k">end</span><span class="p">,</span> <span class="k">fn</span> <span class="n">word</span><span class="p">,</span> <span class="n">acc</span> <span class="o">-&gt;</span>
  <span class="no">Map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="o">&amp;</span> <span class="nv">&amp;1</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span></code></pre></figure>



<p>Мне хотелось опробовать Flow в действии ещё с тех пор, когда Жозе Валим только представил концепции работы этого модуля на <a href="https://www.youtube.com/watch?v=srtMWzyqdp8">конференции "Elixir Conf 2016"</a>. У меня сразу же возникла мысль разработать инструмент для построения системы рекомендаций на основе отзывов большого количества людей (краудсорсинг). Так как это предполагает наличие задач с интенсивным вводом-выводом (HTTP-запросы) и операций с высокой вычислительной нагрузкой на CPU (например, анализ тональности текста), то параллельное исполнение и Flow &ndash; то, что нужно.</p>
<p>Так я и создал страницу <a href="https://startlearningelixir.com/">Start learning Elixir</a>.</p>
<h3>Start learning Elixir</h3>
<blockquote><a href="https://startlearningelixir.com/">Start learning Elixir</a> поможет найти лучшие ресурсы для изучения Elixir.</blockquote>
<img src="https://10consulting.com/assets/2017-01-20-start-learning-elixir.png" alt="Start Learning Elixir">
<p>Краудсорсинг я использовал для того, чтобы найти и оценить подходящие учебные материалы: книги, электронные книги, видеоролики и обучающие курсы.</p>
<p>Алгоритм ранжирования основан на совокупности показателей популярности и результатов анализа тональности. Популярные материалы с высоким рейтингом имеют высокую оценку. Оценка&nbsp;&ndash; совокупность положительных, отрицательных и нейтральных отзывов пользователей известного <a href="https://elixirforum.com/">форума об Elixir</a>.</p>
<h2>Создание инструмента рекомендации товаров</h2>
<p>Разработанное мной зонтичное приложение (umbrella application) на Elixir состоит из трёх приложений:</p>
<ul>
  <li>
    <code>indexer</code>, осуществляющего выборку внешнего контента с помощью HTTP-запросов и упорядочивающего товары по рейтингу.
  </li>
  <li>
    <code>recommendations</code>, содержащего область Ecto schema и запросы: ресурсы, отзывы, оценки, авторы.
  </li>
  <li>
    <code>web</code>&nbsp;&ndash; фронтенд-части приложения в Phoenix, реализующей вывод рекомендованных товаров.
  </li>
</ul>
<p>Flow используется в приложении <code>indexer</code>, где производятся все вычисления. Я набросал схему этапов конвейера, после чего разработал отдельный модуль для каждого этапа. Каждый этап разрабатывался и тестировался изолированно. Затем я объединил модули в единое целое и наладил их работу с помощью соответствующей функции Flow.</p>
<h3>Высокоуровневый поток</h3>
<p>В своём проекте разработки системы рекомендаций я использовал следующий непрерывный процесс:</p>
<ul>
  <li>
    Создание списка рекомендованных ресурсов (подходящих книг, демо-роликов, сайтов, обучающих курсов) вручную.
  </li>
  <li>
    Определение набора ключевых слов:
    <ul>
      <li>
        "научиться", "книга", "книги", "электронные книги", "видео", "учебное пособие", "программирование на Elixir" и т. д.
      </li>
    </ul>
  </li>
  <li>
    Поиск по ключевому слову на <a href="https://elixirforum.com/">форуме об Elixir</a> и получение списка тем.
  </li>
  <li>
    Выборка постов по данной теме:
    <ul>
      <li>
        парсинг содержимого поста (html-страницы);
      </li>
      <li>
        удаление тегов <code>&lt;aside/&gt;</code>&nbsp;и&nbsp;<code>&lt;code/&gt;</code>;
      </li>
      <li>
        разделение текста на предложения тегом <code>&lt;p&gt;</code>;
      </li>
      <li>
        извлечение текста.
      </li>
    </ul>
  </li>
  <li>
    Поиск названий ресурсов в тексте.
  </li>
  <li>
    Выделение положительных, отрицательных и нейтральных отзывов с помощью анализа тональности текста.
  </li>
  <li>
    Объединение комментариев от одного и того же автора.
  </li>
  <li>
    Оценка ресурсов и начисление им рейтинга согласно частоте их упоминания и характера отзывов с использованием сглаживания Лапласа.
  </li>
</ul>
<p>Получаем следующий код на Elixir (при участии <code>Flow</code>):</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Index mentions of resources from an authoritative source.
  """</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="p">{</span>
    <span class="no">Mention</span><span class="p">,</span>
    <span class="no">Post</span><span class="p">,</span>
    <span class="no">Ranking</span><span class="p">,</span>
    <span class="no">Resource</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nv">@doc</span> <span class="sd">"""
  Rank the given resources based on their mentions in topics matching the given keywords
  """</span>
  <span class="nv">@spec</span> <span class="n">rank</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">t</span><span class="p">),</span> <span class="n">list</span><span class="p">(</span><span class="no">Resource</span><span class="o">.</span><span class="n">t</span><span class="p">))</span> <span class="p">::</span> <span class="n">list</span><span class="p">(</span><span class="no">Ranking</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
  <span class="k">def</span> <span class="n">rank</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="n">keywords</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">from_enumerable</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">opts</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">uniq</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">list_posts</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">opts</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="ss">key:</span> <span class="p">{</span><span class="ss">:key</span><span class="p">,</span> <span class="ss">:id</span><span class="p">})</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">uniq_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">parse_html_content</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">parse_sentences</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">extract_mentions</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">resources</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">sentiment_analysis</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="ss">key:</span> <span class="p">{</span><span class="ss">:key</span><span class="p">,</span> <span class="ss">:resource</span><span class="p">})</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">resource</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">mentions</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="no">Indexer</span><span class="o">.</span><span class="n">aggregate_mentions_by_author</span><span class="p">(</span><span class="n">mentions</span><span class="p">)}</span> <span class="k">end</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="no">Indexer</span><span class="o">.</span><span class="n">rank_recommendations</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">score</span><span class="p">),</span> <span class="o">&amp;&gt;=/</span><span class="m">2</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>


<p>Можно заметить, что на некоторых этапах конвейера присутствуют дополнительные функции <code>Flow.partition</code>. Дополнительное разбиение позволяет убедиться в том, что данные передаются в тот же процесс, и минимизировать количество передаваемых сообщений. Для секционирования данных используется хэш-функция. Можно провести секционирование по функции, или по ключу-кортежу, это также необходимо при объединении или разделении каких-либо данных. При секционировании данные в каждой секции не будут накладываться друг на друга.</p>
<p>Подробнее об этапах конвейера Flow:</p>
<ul>
  <li>
    <p><a href="#search-topics-by-keyword">Поиск тем по ключевому слову</a></p>
  </li>
  <li>
    <p><a href="#parse-html-content">Парсинг HTML-кода</a></p>
  </li>
  <li>
    <p><a href="#parse-sentences">Парсинг предложений</a></p>
  </li>
  <li>
    <p><a href="#extract-mentions">Извлечение названий товаров</a></p>
  </li>
  <li>
    <p><a href="#sentiment-analysis">Анализ тональности</a></p>
  </li>
  <li>
    <p><a href="#score-recommendations">Рекомендации (оценки)</a></p>
  </li>
</ul>
<h3>Поиск тем по ключевому слову</h3>
<p><a href="https://elixirforum.com/">Форум об Elixir</a> построен на платформе <a href="http://www.discourse.org/">Discourse</a> с общедоступным интерфейсом, предоставляющим данные в формате JSON. Для этого достаточно будет просто добавить <code>.json</code> к запросу.</p>
<p>Поисковый запрос по слову "book" (<a href="https://elixirforum.com/search?q=book)">https://elixirforum.com/search?q=book)</a> превратится в <a href="https://elixirforum.com/search.json?q=book.">https://elixirforum.com/search.json?q=book.</a> Таким же образом можно осуществлять поиск по отдельно взятым темам.</p>
<p>Я разработал простенький модуль <code>ElixirForum</code>, в котором для отправки HTTP-запросов использовал клиент-приложение <a href="https://github.com/edgurgel/httpoison">HTTPoison</a>, а для парсинга страницы&nbsp;&ndash; библиотеку <a href="https://github.com/devinus/poison">Poison</a>.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Sources</span><span class="o">.</span><span class="no">ElixirForum</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">HTTPoison</span><span class="o">.</span><span class="no">Base</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Cache</span><span class="o">.</span><span class="no">HttpRequestCache</span>
  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Sources</span><span class="o">.</span><span class="no">ElixirForum</span>

  <span class="nv">@endpoint</span> <span class="sd">"</span><span class="s2">https://elixirforum.com"</span>

  <span class="k">defp</span> <span class="n">process_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">do</span>
    <span class="nv">@endpoint</span> <span class="o">&lt;&gt;</span> <span class="n">path</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">process_response_body</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">body</span>
    <span class="o">|&gt;</span> <span class="no">Poison</span><span class="o">.</span><span class="n">decode!</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">cached_request!</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">HttpRequestCache</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="sd">"</span><span class="s2">elixirforum.com/"</span> <span class="o">&lt;&gt;</span> <span class="n">url</span><span class="p">,</span> <span class="k">fn</span> <span class="o">-&gt;</span>
      <span class="n">rate_limit_access</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span>
        <span class="no">ElixirForum</span><span class="o">.</span><span class="n">get!</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
      <span class="k">end</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">rate_limit_access</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:scale</span><span class="p">,</span> <span class="m">1_000</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="ss">:limit</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>

    <span class="k">case</span> <span class="no">ExRated</span><span class="o">.</span><span class="n">check_rate</span><span class="p">(</span><span class="nv">@endpoint</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">request</span><span class="o">.</span><span class="p">()</span>

      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="ss">:timer</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">1_000</span><span class="p">)</span>
        <span class="n">rate_limit_access</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">defmodule</span> <span class="no">Search</span> <span class="k">do</span>
    <span class="nv">@expected_fields</span> <span class="sx">~w(posts topics)</span>

    <span class="k">def</span> <span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
      <span class="sd">"</span><span class="s2">/search.json?"</span> <span class="o">&lt;&gt;</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode_query</span><span class="p">(</span><span class="ss">q:</span> <span class="n">q</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">ElixirForum</span><span class="o">.</span><span class="n">cached_request!</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Map</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="nv">@expected_fields</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span><span class="p">({</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="no">String</span><span class="o">.</span><span class="n">to_existing_atom</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">}</span> <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Чтобы поисковой робот работал надлежащим образом, на доступ к сайту с помощью <a href="https://github.com/grempe/ex_rated">ExRated</a> поставлено ограничение по скорости так, что посылать можно лишь один запрос в секунду. Такое ограничение действует для всех запросов в данном модуле, независимо от вызывающего процесса, так как ExRated, как и GenServer, запускается с собственным состоянием.</p>
<p>Выглядит это так:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="no">ElixirForum</span><span class="o">.</span><span class="no">Search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sd">"</span><span class="s2">books"</span><span class="p">,</span> <span class="p">[</span><span class="ss">scale:</span> <span class="m">1_000</span><span class="p">,</span> <span class="ss">limit:</span> <span class="m">1</span><span class="p">])</span></code></pre></figure>

<p>Отклики кэшируются на диск, чтобы повторные запросы не повлияли на работу сайта.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Cache</span><span class="o">.</span><span class="no">HttpRequestCache</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="kn">require</span> <span class="no">Logger</span>

  <span class="k">defmodule</span> <span class="no">State</span> <span class="k">do</span>
    <span class="n">defstruct</span> <span class="p">[</span>
      <span class="ss">cache_dir:</span> <span class="no">nil</span>
    <span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">%</span><span class="no">State</span><span class="p">{</span><span class="ss">cache_dir:</span> <span class="n">cache_dir</span><span class="p">},</span> <span class="ss">name:</span> <span class="bp">__MODULE__</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(%</span><span class="no">State</span><span class="p">{</span><span class="ss">cache_dir:</span> <span class="n">cache_dir</span><span class="p">}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">File</span><span class="o">.</span><span class="n">mkdir_p!</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">cached</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="n">read</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">value</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">value</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:not_found</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="p">()</span>
        <span class="ss">:ok</span> <span class="o">=</span> <span class="n">cache</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">read</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">{</span><span class="ss">:read</span><span class="p">,</span> <span class="n">key</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">cache</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">{</span><span class="ss">:cache</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_call</span><span class="p">({</span><span class="ss">:read</span><span class="p">,</span> <span class="n">key</span><span class="p">},</span> <span class="n">_from</span><span class="p">,</span> <span class="p">%</span><span class="no">State</span><span class="p">{}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">cached_path</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">reply</span> <span class="o">=</span> <span class="k">case</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">data</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">Poison</span><span class="o">.</span><span class="n">decode!</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:enoent</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:not_found</span><span class="p">}</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">-&gt;</span> <span class="n">reply</span>
    <span class="k">end</span>

    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_call</span><span class="p">({</span><span class="ss">:cache</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">},</span> <span class="n">_from</span><span class="p">,</span> <span class="p">%</span><span class="no">State</span><span class="p">{}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">cached_path</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="no">File</span><span class="o">.</span><span class="n">write!</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="no">Poison</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="p">[</span><span class="ss">:write</span><span class="p">])</span>

    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">cached_path</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">%</span><span class="no">State</span><span class="p">{</span><span class="ss">cache_dir:</span> <span class="n">cache_dir</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">key</span> <span class="o">=</span> <span class="no">String</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">255</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="no">Path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">path</span>
    <span class="o">|&gt;</span> <span class="no">Path</span><span class="o">.</span><span class="n">dirname</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">mkdir_p!</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Модуль кэша HTTP сконфигурирован в супервизоре приложения.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Application</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="no">false</span>

  <span class="kn">use</span> <span class="no">Application</span>

  <span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">import</span> <span class="no">Supervisor</span><span class="o">.</span><span class="no">Spec</span><span class="p">,</span> <span class="ss">warn:</span> <span class="no">false</span>

    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
      <span class="n">worker</span><span class="p">(</span><span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Cache</span><span class="o">.</span><span class="no">HttpRequestCache</span><span class="p">,</span> <span class="p">[</span><span class="sd">"</span><span class="s2">fixture/http_cache"</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">,</span> <span class="ss">name:</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Supervisor</span><span class="p">]</span>
    <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Во время тестирования поиска я снова воспользовался библиотекой&nbsp;<a href="https://github.com/parroty/exvcr">ExVCR</a> для записи HTTP-запросов и откликов и для повторного запуска с диска последующих тестов.</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Sources</span><span class="o">.</span><span class="no">ElixirForumTest</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span><span class="p">,</span> <span class="ss">async:</span> <span class="no">false</span>
  <span class="kn">use</span> <span class="no">ExVCR</span><span class="o">.</span><span class="no">Mock</span><span class="p">,</span> <span class="ss">adapter:</span> <span class="no">ExVCR</span><span class="o">.</span><span class="no">Adapter</span><span class="o">.</span><span class="no">Hackney</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Sources</span><span class="o">.</span><span class="no">ElixirForum</span>

  <span class="n">setup_all</span> <span class="k">do</span>
    <span class="no">HTTPoison</span><span class="o">.</span><span class="n">start</span>
    <span class="ss">:ok</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="sd">"</span><span class="s2">search"</span> <span class="k">do</span>
    <span class="n">test</span> <span class="sd">"</span><span class="s2">for \"</span><span class="n">books</span><span class="p">\</span><span class="sd">"</span><span class="s2">"</span> <span class="k">do</span>
      <span class="n">use_cassette</span> <span class="sd">"</span><span class="s2">elixirforum.com/search.json?&amp;q=book"</span><span class="p">,</span> <span class="ss">match_requests_on:</span> <span class="p">[</span><span class="ss">:query</span><span class="p">]</span> <span class="k">do</span>
        <span class="n">response</span> <span class="o">=</span> <span class="no">ElixirForum</span><span class="o">.</span><span class="no">Search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sd">"</span><span class="s2">book"</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">assert</span> <span class="n">length</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="ss">:posts</span><span class="p">])</span> <span class="o">&gt;</span> <span class="m">0</span>
        <span class="n">assert</span> <span class="n">length</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="ss">:topics</span><span class="p">])</span> <span class="o">&gt;</span> <span class="m">0</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>
<p>Подробнее об этом можно почитать <a href="https://10consulting.com/2016/11/07/http-unit-tests-in-elixir-using-exvcr/">здесь</a>.</p>
<h3>Парсинг HTML-кода</h3>
<p>Для парсинга HTML-кода и извлечения из него текста с помощью CSS-селекторов воспользуемся парсером <a href="https://github.com/philss/floki">Floki</a>.</p>
<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Stages</span><span class="o">.</span><span class="no">ParseHtmlContent</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Parse the HTML post content into paragraphs of text.
  """</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="p">{</span>
    <span class="no">Content</span><span class="p">,</span>
    <span class="no">Post</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="n">execute</span><span class="p">(%</span><span class="no">Post</span><span class="p">{</span><span class="ss">content:</span> <span class="n">content</span><span class="p">}</span> <span class="o">=</span> <span class="n">post</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Post</span><span class="p">{</span><span class="n">post</span> <span class="o">|</span>
      <span class="ss">content:</span> <span class="n">parse_content_html</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">parse_content_html</span><span class="p">(%</span><span class="no">Content</span><span class="p">{</span><span class="ss">html:</span> <span class="n">html</span><span class="p">}</span> <span class="o">=</span> <span class="n">content</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">paragraphs</span> <span class="o">=</span>
      <span class="n">html</span>
      <span class="o">|&gt;</span> <span class="no">Floki</span><span class="o">.</span><span class="n">filter_out</span><span class="p">(</span><span class="sd">"</span><span class="s2">aside"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Floki</span><span class="o">.</span><span class="n">filter_out</span><span class="p">(</span><span class="sd">"</span><span class="s2">pre"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Floki</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sd">"</span><span class="s2">p"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Floki</span><span class="o">.</span><span class="n">text</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="k">fn</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sd">"</span><span class="s2">\n"</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="k">fn</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">==</span> <span class="sd">"</span><span class="s2">"</span> <span class="k">end</span><span class="p">)</span>

    <span class="p">%</span><span class="no">Content</span><span class="p">{</span><span class="n">content</span> <span class="o">|</span>
      <span class="ss">paragraphs:</span> <span class="n">paragraphs</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Абзацы определяются тегом <code>&lt;p&gt;</code>, а функция&nbsp;<code>Floki.text/1</code> вытаскивает из них текст.</p>
<h3>Парсинг предложений</h3>
<p>Выделим отдельные предложения из текста поста. Для этого воспользуемся функцией <code>Essence.Chunker.sentences</code> из NLP-библиотеки <a href="https://github.com/nicbet/essence">essence</a>.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Stages</span><span class="o">.</span><span class="no">ParseSentences</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Parse the paragraphs of text into sentences.
  """</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="p">{</span>
    <span class="no">Content</span><span class="p">,</span>
    <span class="no">Post</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="n">execute</span><span class="p">(%</span><span class="no">Post</span><span class="p">{</span><span class="ss">content:</span> <span class="n">content</span><span class="p">}</span> <span class="o">=</span> <span class="n">post</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Post</span><span class="p">{</span><span class="n">post</span> <span class="o">|</span>
      <span class="ss">content:</span> <span class="n">parse_sentences</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># chunks the given paragraphs into sentences.</span>
  <span class="k">defp</span> <span class="n">parse_sentences</span><span class="p">(%</span><span class="no">Content</span><span class="p">{</span><span class="ss">paragraphs:</span> <span class="n">paragraphs</span><span class="p">}</span> <span class="o">=</span> <span class="n">content</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">sentences</span> <span class="o">=</span>
      <span class="n">paragraphs</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Essence</span><span class="o">.</span><span class="no">Chunker</span><span class="o">.</span><span class="n">sentences</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="k">fn</span> <span class="n">sentences</span> <span class="o">-&gt;</span> <span class="n">sentences</span> <span class="k">end</span><span class="p">)</span>

    <span class="p">%</span><span class="no">Content</span><span class="p">{</span><span class="n">content</span> <span class="o">|</span>
      <span class="ss">sentences:</span> <span class="n">sentences</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3>Извлечение названий товаров</h3>
<p>Чтобы извлечь названия отдельных товаров:</p>
<ol>
  <li>
    Разобьём предложение на отдельные слова, написанные строчными буквами, с помощью функции <code>Essence.Tokenizer.tokenize</code>:
    <ul>
      <li>
        &ldquo;I recommend Elixir in Action&rdquo; превратится в [&ldquo;i, &ldquo;recommend&rdquo;, &ldquo;elixir&rdquo;, &ldquo;in&rdquo;, &ldquo;action&rdquo;]
      </li>
    </ul>
  </li>
  <li>
    Сделаем то же самое с названием товара:
    <ul>
      <li>
        &ldquo;Elixir in Action&rdquo; превратится в [&ldquo;elixir&rdquo;, &ldquo;in&rdquo;, &ldquo;action&rdquo;]
      </li>
    </ul>
  </li>
  <li>
    С помощью функции <code>Enum.chunk</code> произведём перебор расчленённых предложений, передав в неё длину искомого слова и шаг равный единице для учёта перекрытий, и осуществим поиск по заданному имени товара.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defp</span> <span class="n">mentioned?</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="p">%</span><span class="no">Resource</span><span class="p">{</span><span class="ss">name:</span> <span class="n">name</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">contains?</span><span class="p">(</span><span class="n">tokenize_downcase</span><span class="p">(</span><span class="n">sentence</span><span class="p">),</span> <span class="n">tokenize_downcase</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">tokenize_downcase</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">text</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">downcase</span> <span class="o">|&gt;</span> <span class="no">Essence</span><span class="o">.</span><span class="no">Tokenizer</span><span class="o">.</span><span class="n">tokenize</span>

<span class="k">defp</span> <span class="n">contains?</span><span class="p">(</span><span class="n">source_tokens</span><span class="p">,</span> <span class="n">search_tokens</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">source_tokens</span>
  <span class="o">|&gt;</span> <span class="no">Stream</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">search_tokens</span><span class="p">),</span> <span class="m">1</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">any?</span><span class="p">(</span><span class="k">fn</span> <span class="n">chunk</span> <span class="o">-&gt;</span> <span class="n">chunk</span> <span class="o">==</span> <span class="n">search_tokens</span> <span class="k">end</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<h3>Анализ тональности</h3>
<p>Для несложных анализов тональности я обычно использую систему <a href="https://github.com/dantame/sentient">Sentient</a>. Она работает на основе списка слов <a href="http://www2.imm.dtu.dk/pubdb/views/publication_details.php?id=6010">AFINN-111</a>,&nbsp;разделяя предложения на положительные, отрицательные и нейтральные на основе присутствия этих слов в тексте и их эмоциональной окраски.</p>
<blockquote>AFINN&nbsp;&ndash; это список английских слов, отмеченных целыми числами согласно их коннотациям от минус пяти (отрицательная коннотация) до плюс пяти (положительная коннотация).</blockquote>
<p>К примеру, текст "я рекомендую книгу "Elixir in Action" к прочтению" получит положительную оценку, поскольку слово "рекомендовать" отмечено значением числом +2. Список AFINN-111 содержит 2477 слов. Этот простейший алгоритм вполне адекватно оценивает тональность предложений.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Stages</span><span class="o">.</span><span class="no">SentimentAnalysis</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Analyse the mention sentence for its sentiment (positive, neutral, or negative).

  Uses the AFINN-111 word list.
  """</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="p">{</span>
    <span class="no">Mention</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nv">@spec</span> <span class="n">execute</span><span class="p">(</span><span class="no">Mention</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="p">::</span> <span class="no">Mention</span><span class="o">.</span><span class="n">t</span>
  <span class="k">def</span> <span class="n">execute</span><span class="p">(%</span><span class="no">Mention</span><span class="p">{}</span> <span class="o">=</span> <span class="n">mention</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Mention</span><span class="p">{</span><span class="n">mention</span> <span class="o">|</span>
      <span class="ss">sentiment_score:</span> <span class="n">sentiment</span><span class="p">(</span><span class="n">mention</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="nv">@override_words</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">free"</span> <span class="o">=&gt;</span> <span class="m">0</span><span class="p">}</span>

  <span class="k">defp</span> <span class="n">sentiment</span><span class="p">(%</span><span class="no">Mention</span><span class="p">{</span><span class="ss">sentence:</span> <span class="n">sentence</span><span class="p">})</span> <span class="k">do</span>
    <span class="no">Sentient</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="nv">@override_words</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Оценка тональности предложения, содержащего название товара, добавляется к общей оценке этого товара.</p>
<h3>Рекомендации (оценки)</h3>
<p>Общая оценка определяется заново каждый раз, когда в тексте было найдено название того или иного товара и была проведена оценка тональности.</p>
<p>Чтобы при оценке отделить соотношение положительных/отрицательных отзывов от малого количества отзывов по товару, воспользуемся формулой сглаживания Лапласа:</p>

<figure class="highlight"><pre><code class="language-foo" data-lang="foo">score = (upvotes + α) / (upvotes + downvotes + β)</code></pre></figure>

<p>Например, при &alpha; = 1 и &beta; = 2 товар без голосов получит оценку 0,5.</p>
<p>По каждому товару могут быть положительные, отрицательные и нейтральные отзывы. В моём случае каждый нейтральный комментарий получает оценку +1, а каждый положительный получает +2.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="no">Stages</span><span class="o">.</span><span class="no">RankRecommendations</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Combine recommendations for the same resource into a single ranking and score
  """</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="p">{</span>
    <span class="no">Ranking</span><span class="p">,</span>
    <span class="no">Recommendation</span><span class="p">,</span>
    <span class="no">Resource</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nv">@spec</span> <span class="n">execute</span><span class="p">(</span><span class="no">Resource</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">list</span><span class="p">(</span><span class="no">Recommendation</span><span class="o">.</span><span class="n">t</span><span class="p">))</span> <span class="p">::</span> <span class="no">Ranking</span><span class="o">.</span><span class="n">t</span>
  <span class="k">def</span> <span class="n">execute</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Ranking</span><span class="p">{</span>
      <span class="ss">resource:</span> <span class="n">resource</span><span class="p">,</span>
      <span class="ss">recommendations:</span> <span class="n">recommendations</span><span class="p">,</span>
      <span class="ss">score:</span> <span class="n">calculate_score</span><span class="p">(</span><span class="n">recommendations</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># calculate score by using Laplace smoothing on positive, neutral and negative mentions</span>
  <span class="k">defp</span> <span class="n">calculate_score</span><span class="p">([]),</span> <span class="k">do</span><span class="p">:</span> <span class="m">0</span>
  <span class="k">defp</span> <span class="n">calculate_score</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">recommendations</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p">({</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">},</span> <span class="o">&amp;</span><span class="no">Recommendation</span><span class="o">.</span><span class="n">score</span><span class="o">/</span><span class="m">2</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">score</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">score</span><span class="p">({</span><span class="n">negative</span><span class="p">,</span> <span class="n">neutral</span><span class="p">,</span> <span class="n">positive</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">upvotes</span> <span class="o">=</span> <span class="n">neutral</span> <span class="o">+</span> <span class="p">(</span><span class="n">positive</span> <span class="o">*</span> <span class="m">2</span><span class="p">)</span>
    <span class="n">downvotes</span> <span class="o">=</span> <span class="n">negative</span>

    <span class="p">(</span><span class="n">upvotes</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upvotes</span> <span class="o">+</span> <span class="n">downvotes</span> <span class="o">+</span> <span class="m">2</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Существует исследование о применении сглаживания Лапласа для "предоставления наиболее верного решения проблемы ранжирования информации на основе оценок пользователей в веб-приложениях".</p>
<ul>
  <li>
    <p><a href="http://planspace.org/2014/08/17/how-to-sort-by-average-rating/">Сортировка по среднему рейтингу</a></p>
  </li>
  <li>
    <p><a href="http://www.dcs.bbk.ac.uk/~dell/publications/dellzhang_ictir2011.pdf">Подсчёт положительных и отрицательных оценок: ранжирование информации на основе оценок пользователей с аксиоматической точки зрения</a> (PDF)</p>
  </li>
</ul>
<h2>Рекомендации (краудсорсинг)</h2>
<p>Объединяя отдельные этапы в единый конвейер с помощью Flow, можно оценить любой товар по отзывам на него.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">def</span> <span class="n">index_mentions</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
  <span class="n">keywords</span>
  <span class="o">|&gt;</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="n">record_rankings</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p><a href="https://github.com/elixir-ecto/ecto">Ecto</a> сохраняет их в базу данных PostgreSQL. Отобразить товары, упорядоченные по рейтингу, поможет Ecto-запрос, представленный ниже. Товары можно отсортировать по языку программирования или по уровню знания языка и классифицировать их по этим признакам на сайте.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Recommendations</span><span class="o">.</span><span class="no">Queries</span><span class="o">.</span><span class="no">RecommendedResources</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Query</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Recommendations</span><span class="o">.</span><span class="p">{</span>
    <span class="no">Resource</span><span class="p">,</span>
    <span class="no">Score</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="n">new</span> <span class="k">do</span>
    <span class="n">from</span> <span class="n">r</span> <span class="ow">in</span> <span class="no">Resource</span><span class="p">,</span>
    <span class="ss">left_join:</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">assoc</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="ss">:score</span><span class="p">),</span>
    <span class="ss">order_by:</span> <span class="p">[</span><span class="ss">asc:</span> <span class="n">s</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="ss">asc:</span> <span class="n">r</span><span class="o">.</span><span class="n">title</span><span class="p">],</span>
    <span class="ss">preload:</span> <span class="p">[</span><span class="ss">:score</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">by_experience</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">from</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="ow">in</span> <span class="n">query</span><span class="p">,</span>
    <span class="ss">where:</span> <span class="n">r</span><span class="o">.</span><span class="n">experience_level</span> <span class="o">==</span> <span class="o">^</span><span class="n">level</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">by_language</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">from</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="ow">in</span> <span class="n">query</span><span class="p">,</span>
    <span class="ss">where:</span> <span class="n">r</span><span class="o">.</span><span class="n">programming_language</span> <span class="o">==</span> <span class="o">^</span><span class="n">language</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Контроллер Phoenix составляет запрос и осуществляет выборку подходящих ресурсов с помощью функции <code>Repo.all/2</code>:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">ResourceController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Recommendations</span><span class="o">.</span><span class="no">Repo</span><span class="p">,</span>
  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Recommendations</span><span class="o">.</span><span class="no">Queries</span><span class="o">.</span><span class="no">RecommendedResources</span>

  <span class="k">def</span> <span class="n">index</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="o">=</span>
      <span class="no">RecommendedResources</span><span class="o">.</span><span class="n">new</span>
      <span class="o">|&gt;</span> <span class="no">RecommendedResources</span><span class="o">.</span><span class="n">by_experience</span><span class="p">(</span><span class="sd">"</span><span class="s2">beginner"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">RecommendedResources</span><span class="o">.</span><span class="n">by_language</span><span class="p">(</span><span class="sd">"</span><span class="s2">Elixir"</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="sd">"</span><span class="s2">index.html"</span><span class="p">,</span> <span class="ss">resources:</span> <span class="n">resources</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3>Заключение</h3>
<p>Рассмотренное приложение&nbsp;&ndash; пример использования Flow для построения вычислительного конвейера с параллельным выполнением операций для решения реальных задач. Предполагалось, что применение упрощённого алгоритма построения системы рекомендаций не имеет особого смысла. Однако, взглянув на конечные результаты, можно констатировать обратное: популярные ресурсы с высоким рейтингом занимают положение на вершине списка. Значение популярности, формирующееся из комментариев пользователей и результатов анализа тональности, может быть использовано для ранжирования товаров.</p>
<p>Недавно я добавил на сайт отслеживание активности пользователей, чтобы затем использовать эти значения для оценки. Таким образом, наиболее часто просматриваемые ресурсы имеют более высокий рейтинг. Возможно, в скором времени на сайте появится ещё и механизм обратной связи, чтобы пользователи могли отмечать ошибочные отзывы и оставлять свои.</p>
<p><a href="mailto:ben@10consulting.com">Свяжитесь со мной</a>, если у вас возникли какие-либо вопросы и предложения.</p>
<hr />
<h2>Оптимизация</h2>
<p>Я был приятно удивлён алгоритмом оптимизации моего конвейера Flow, представленным <a href="http://teamon.eu/about/">Таймоном Тобольски</a>, который написал две чудесные статьи на эту тему.</p>
<ul>
  <li>
    <a href="http://teamon.eu/2016/tuning-elixir-genstage-flow-pipeline-processing/">Оптимизация обработки данных с помощью GenStage/Flow в Elixir</a>
  </li>
  <li>
    <a href="http://teamon.eu/2016/measuring-visualizing-genstage-flow-with-gnuplot/">Измерения и визуализация работы GenStage/Flow с помощью GnuPlot</a>
  </li>
</ul>
<p>Взяв разработанный им модуль&nbsp;Progress и исходный код GnuPlot, я смог провести оптимизацию своего конвейера и визуализировать результаты его работы.</p>
<h3>Отслеживание прогресса</h3>
<p>Модуль <code>Learn.Progress</code> целиком взят из статьи Таймона.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Progress</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Progress stats collector, courtesy of http://teamon.eu/2016/measuring-visualizing-genstage-flow-with-gnuplot/
  """</span>

  <span class="kn">use</span> <span class="no">GenServer</span>

  <span class="nv">@timeres</span> <span class="ss">:millisecond</span>

  <span class="c1"># Progress.start_link [:a, :b, :c]</span>
  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">scopes</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="ss">name:</span> <span class="bp">__MODULE__</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">stop</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># increment counter for given scope by `n`</span>
  <span class="c1">#     Progress.incr(:my_scope)</span>
  <span class="c1">#     Progress.incr(:my_scope, 10)</span>
  <span class="k">def</span> <span class="n">incr</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">n</span> <span class="p">\\</span> <span class="m">1</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">cast</span> <span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">{</span><span class="ss">:incr</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">n</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">File</span><span class="o">.</span><span class="n">mkdir_p!</span><span class="p">(</span><span class="sd">"</span><span class="s2">fixture/trace"</span><span class="p">)</span>

    <span class="c1"># open "progress-{scope}.log" file for every scope</span>
    <span class="n">files</span> <span class="o">=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span> <span class="k">fn</span> <span class="n">scope</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="n">scope</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">open!</span><span class="p">(</span><span class="sd">"</span><span class="s2">fixture/trace/progress-</span><span class="si">#{</span><span class="n">scope</span><span class="si">}</span><span class="s2">.log"</span><span class="p">,</span> <span class="p">[</span><span class="ss">:write</span><span class="p">])}</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="c1"># keep current counter for every scope</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span> <span class="k">fn</span> <span class="n">scope</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">scope</span><span class="p">,</span> <span class="m">0</span><span class="p">}</span> <span class="k">end</span><span class="p">)</span>

    <span class="c1"># save current time</span>
    <span class="n">time</span> <span class="o">=</span> <span class="ss">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p">(</span><span class="nv">@timeres</span><span class="p">)</span>

    <span class="c1"># write first data point for every scope with current time and value 0</span>
    <span class="c1"># this helps to keep the graph starting nicely at (0,0) point</span>
    <span class="no">Enum</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="k">fn</span> <span class="p">{</span><span class="n">_</span><span class="p">,</span> <span class="n">io</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>

    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="n">time</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">counts</span><span class="p">}}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_cast</span><span class="p">({</span><span class="ss">:incr</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">n</span><span class="p">},</span> <span class="p">{</span><span class="n">time</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">counts</span><span class="p">})</span> <span class="k">do</span>
    <span class="c1"># update counter</span>
    <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="n">counts</span><span class="p">}</span> <span class="o">=</span> <span class="no">Keyword</span><span class="o">.</span><span class="n">get_and_update!</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">({</span><span class="nv">&amp;1</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="nv">&amp;1</span><span class="o">+</span><span class="n">n</span><span class="p">}))</span>

    <span class="c1"># write new data point</span>
    <span class="n">write</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">scope</span><span class="p">],</span> <span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="p">{</span><span class="n">time</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">counts</span><span class="p">}}</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">time</span> <span class="o">=</span> <span class="ss">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p">(</span><span class="nv">@timeres</span><span class="p">)</span> <span class="o">-</span> <span class="n">time</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="sd">"</span><span class="si">#{</span><span class="n">time</span><span class="si">}</span><span class="s2">\t</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">\n"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Я также воспользовался библиотекой&nbsp;<a href="https://github.com/arjan/decorator">decorator</a> Арджана Шерпениссе, чтобы добавить отслеживание прогресса в функцию каждого этапа конвейера, поставив перед объявлением каждой функции <code>@decorate progress</code>.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Index mentions of resources from an authoritative source.
  """</span>

  <span class="kn">use</span> <span class="no">Learn</span><span class="o">.</span><span class="no">ProgressDecorator</span>

  <span class="nv">@doc</span> <span class="sd">"""
  Search for topics matching a given query
  """</span>
  <span class="nv">@decorate</span> <span class="n">progress</span>
  <span class="k">def</span> <span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[]),</span> <span class="k">do</span><span class="p">:</span> <span class="no">SearchKeyword</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>Декоратор увеличивает счётчик метода после его выполнения. Счётчик увеличивается на количество элементов в возвращаемом функцией списке или на единицу, если список не был возвращён.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">ProgressDecorator</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Decorator</span><span class="o">.</span><span class="no">Define</span><span class="p">,</span> <span class="p">[</span><span class="ss">progress:</span> <span class="m">0</span><span class="p">]</span>

  <span class="n">alias</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Progress</span>

  <span class="k">def</span> <span class="n">progress</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="n">reply</span> <span class="o">=</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

      <span class="k">case</span> <span class="n">reply</span> <span class="k">do</span>
        <span class="n">list</span> <span class="ow">when</span> <span class="n">is_list</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="no">Progress</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">length</span><span class="p">(</span><span class="n">list</span><span class="p">))</span>
        <span class="n">_</span> <span class="o">-&gt;</span> <span class="no">Progress</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="m">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">reply</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>


<p>Функция&nbsp;<code>Learn.Indexer.rank/3</code> передаёт в процесс имя каждого этапа перед выполнением потока. После этого она останавливает процесс, проверяет, чтобы файлы журналов были созданы и закрыты.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Learn</span><span class="o">.</span><span class="no">Indexer</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Index mentions of resources from an authoritative source.
  """</span>

  <span class="nv">@doc</span> <span class="sd">"""
  Rank the given resources based on their mentions in topics matching the given keywords
  """</span>
  <span class="nv">@spec</span> <span class="n">rank</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">t</span><span class="p">),</span> <span class="n">list</span><span class="p">(</span><span class="no">Resource</span><span class="o">.</span><span class="n">t</span><span class="p">))</span> <span class="p">::</span> <span class="n">list</span><span class="p">(</span><span class="no">Ranking</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
  <span class="k">def</span> <span class="n">rank</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="no">Progress</span><span class="o">.</span><span class="n">start_link</span><span class="p">([</span>
      <span class="ss">:search</span><span class="p">,</span>
      <span class="ss">:list_posts</span><span class="p">,</span>
      <span class="ss">:parse_html_content</span><span class="p">,</span>
      <span class="ss">:parse_sentences</span><span class="p">,</span>
      <span class="ss">:extract_mentions</span><span class="p">,</span>
      <span class="ss">:sentiment_analysis</span><span class="p">,</span>
      <span class="ss">:aggregate_mentions_by_author</span><span class="p">,</span>
      <span class="ss">:rank_recommendations</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="n">rankings</span> <span class="o">=</span>
      <span class="n">keywords</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">from_enumerable</span><span class="p">(</span><span class="ss">max_demand:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">stages:</span> <span class="m">1</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">opts</span><span class="p">))</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">uniq</span><span class="p">()</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="ss">max_demand:</span> <span class="m">5</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">list_posts</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">opts</span><span class="p">))</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="ss">key:</span> <span class="p">{</span><span class="ss">:key</span><span class="p">,</span> <span class="ss">:id</span><span class="p">},</span> <span class="ss">max_demand:</span> <span class="m">5</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">uniq_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">parse_html_content</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">parse_sentences</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">extract_mentions</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="n">resources</span><span class="p">))</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Indexer</span><span class="o">.</span><span class="n">sentiment_analysis</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="ss">key:</span> <span class="p">{</span><span class="ss">:key</span><span class="p">,</span> <span class="ss">:resource</span><span class="p">},</span> <span class="ss">max_demand:</span> <span class="m">5</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">resource</span><span class="p">))</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">mentions</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="no">Indexer</span><span class="o">.</span><span class="n">aggregate_mentions_by_author</span><span class="p">(</span><span class="n">mentions</span><span class="p">)}</span> <span class="k">end</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Flow</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="p">{</span><span class="n">resource</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="no">Indexer</span><span class="o">.</span><span class="n">rank_recommendations</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">score</span><span class="p">),</span> <span class="o">&amp;&gt;=/</span><span class="m">2</span><span class="p">)</span>

    <span class="no">Progress</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">rankings</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>


<h4>Визуализация потока</h4>
<p>После запуска индексатора, в котором функции этапов были отмечены тегом <code>@progress</code>, я построил графики "до" и "после".</p>
<h5>Изначальный поток</h5>
<p>В первоначальной версии приложения поток запускался в течение 33 секунд. HTTP-кэш заполнен, внешние запросы отсутствуют.</p>

<img src="https://10consulting.com/assets/2017-01-20-flow-initial.png" alt="Elixir Flow processing">


<h5>Поток после оптимизации</h5>
<p>Я изменил опции <code>max_demand</code>&nbsp;и&nbsp;<code>stages</code> для некоторых этапов Flow, как показано выше. Это позволило сократить время запуска потока с 33 секунд до 26.</p>

<img src="https://10consulting.com/assets/2017-01-20-flow-after.png" alt="Optimized Elixir Flow processing">



<p>Графики были построены с помощью следующего кода (GnuPlot): Они показывают прогресс выполнения каждого этапа в процентах. Полученные рекомендации, упорядоченные по рейтингу, показаны на отдельной оси y.</p>

<figure class="highlight"><pre><code class="language-foo" data-lang="foo"># plot.gp
set terminal png font "Arial,10" size 700,500
set output "progress.png"

set title "Elixir Flow processing progress over time"
set xlabel "Time (ms)"

set ylabel "Progress (%)"
set y2label "Rankings"
set ytics nomirror
set yrange [0:100]
set format y '%2.0f%%'
set y2tics

set key top left # put labels in top-left corner

# limit x range to 35.000 ms instead of dynamic one - needed when generating graphs that will be later compared visually
set xrange [0:35000]

plot  "trace/progress-search.log"                         using ($1):($2/1249*100)  with steps  axes x1y1 ls 1 title "Search topics",\
      "trace/progress-search.log"                         using ($1):($2/1249*100)  with points axes x1y1 ls 1 notitle,\
      "trace/progress-list_posts.log"                     using ($1):($2/14974*100) with lines  axes x1y1 ls 2 title "List posts",\
      "trace/progress-parse_html_content.log"             using ($1):($2/6780*100)  with lines  axes x1y1 ls 3 title "Parse HTML",\
      "trace/progress-parse_sentences.log"                using ($1):($2/6780*100)  with lines  axes x1y1 ls 4 title "Parse sentences",\
      "trace/progress-extract_mentions.log"               using ($1):($2/515*100)   with lines  axes x1y1 ls 5 title "Extract mentions",\
      "trace/progress-sentiment_analysis.log"             using ($1):($2/515*100)   with lines  axes x1y1 ls 6 title "Sentiment analysis",\
      "trace/progress-aggregate_mentions_by_author.log"   using ($1):($2/314*100)   with lines  axes x1y1 ls 7 title "Aggregate mentions by author",\
      "trace/progress-rank_recommendations.log"                                     with steps  axes x1y2 ls 8 title "Rank",\
      "trace/progress-rank_recommendations.log"                                     with points axes x1y2 ls 8 notitle</code></pre></figure>

  </div>

  <!-- uSocial -->
  <div class="post__share_block share_block">
    <script async src="https://usocial.pro/usocial/usocial.js?v=6.1.4" data-script="usocial" charset="utf-8"></script>
    <div class="uSocial-Share" data-pid="2fd19544e551bce292425ee8adaa31be" data-type="share" data-options="round,style2,default,absolute,horizontal,size32,counter1,counter-before,upArrow-right,nomobile" data-social="telegram,fb,vk,gPlus,twi,bookmarks"></div>
  </div>
  <!-- /uSocial -->
</article>


        <footer class="footer">
    &copy; 2020
    / Россия

    <span class="pull-right">Любые мысли и вопросы пишите на <a href="mailto:elixir@wunsh.ru">elixir@wunsh.ru</a>.</span>
</footer>

        <div id="subscribeModal" class="modal">
    <div class="modal__content">
        <a href="#close" title="Close" class="modal__close">x</a>

        <h2 class="modal__title">Ламповая рассылка про&nbsp;Эликсир</h2>

        <p>Один-два раза в&nbsp;неделю присылаем тёплые письма об&nbsp;Эликсире: переводы самых интересных статей до&nbsp;их&nbsp;появления в&nbsp;открытом доступе, анонсы событий и&nbsp;вкусные бонусы.</p>

        <form action="//wunsh.us14.list-manage.com/subscribe/post?u=c81ca3d4693f62db7f7f67c71&amp;id=a192e2dfef" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="pure-form h-tc validate" target="_blank" novalidate>
            <input type="email" value="" name="EMAIL" class="modal__input pure-input-rounded large" id="mce-EMAIL" placeholder="Твоя почта" required>
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_c81ca3d4693f62db7f7f67c71_a192e2dfef" tabindex="-1" value=""></div>

            <input type="submit" value="Присоединиться" name="subscribe" onClick="yaCounter39773490.reachGoal('SUBSCRIBED'); return true" id="mc-embedded-subscribe" class="pure-button button-success large">
        </form>

        <p>Обязательно подтверди почту, перейдя по&nbsp;ссылке в&nbsp;письме, иначе мы&nbsp;не&nbsp;сможем делиться с&nbsp;тобой полезностями.</p>

        <p>Надоедать точно не&nbsp;будем :)</p>
    </div>
</div>

        <script src="/assets/js/vendors/zepto.min.js"></script>

<script>
    if ($(".post--docs").length) {
        $(".footer").addClass("footer--docs")
    }

    $(".modal--close_backdrop").click(function(){
        window.location.hash = "";
    });
</script>

        <!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter39773490 = new Ya.Metrika({
                    id:39773490,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true,
                    ut:"noindex"
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/39773490?ut=noindex" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

      </div>
    </div>
  </body>
</html>
